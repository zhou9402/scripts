# GQA Prefill/Decode/Hybrid SM ç¼©æ”¾æµ‹è¯•

## ğŸš€ Green Context åº“ç¼–è¯‘æŒ‡å—

### ğŸ› ï¸ ç¼–è¯‘æ­¥éª¤

1. **æ£€æŸ¥ä¾èµ–ç¯å¢ƒ**  
   éœ€æå‰å®‰è£… `torch` å’Œ `pybind11`ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š
   ```bash
   pip install torch pybind11 flashinfer
   ```

2. **æ‰§è¡Œç¼–è¯‘è„šæœ¬**  
   åœ¨ `semi-pd` ç›®å½•ä¸‹è¿è¡Œï¼š
   ```bash
   bash build_library.sh
   ```
   ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆ `green_context_lib*.so` æ–‡ä»¶ã€‚

3. **å¯¼å…¥åº“æµ‹è¯•**  
   ç¼–è¯‘å®Œæˆåå¯åœ¨ Python ä¸­ç›´æ¥å¯¼å…¥ï¼š
   ```python
   import green_context_lib as green_context
   
   # æµ‹è¯•API
   primary_stream, remaining_stream, primary_sms, remaining_sms = \
       green_context.create_green_context_and_streams(
           intended_primary_sm_count=64
       )
   print(f"Primary: {primary_sms} SMs, Remaining: {remaining_sms} SMs")
   green_context.destroy_green_context()
   ```

**âš ï¸ é‡è¦æç¤º**: æœ¬æ–‡æ¡£å¯¹åº”çš„ `green_context_wrapper.cu` å·²æ›´æ–°ä¸ºæ”¯æŒ primary/remaining partition çš„æ–°ç‰ˆæœ¬ã€‚å¦‚æœä¹‹å‰ç¼–è¯‘è¿‡æ—§ç‰ˆæœ¬ï¼Œè¯·é‡æ–°ç¼–è¯‘ï¼š
```bash
rm green_context_lib*.so  # åˆ é™¤æ—§çš„.soæ–‡ä»¶
bash build_library.sh      # é‡æ–°ç¼–è¯‘
```

---

## ğŸ“– æµ‹è¯•è„šæœ¬è¯´æ˜

è¿™äº›æµ‹è¯•è„šæœ¬ç”¨äºè¯„ä¼° **GQA (Grouped Query Attention)** åœ¨ä¸åŒ SM æ•°é‡é™åˆ¶ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼ŒåŒ…æ‹¬ï¼š
- **Prefill**: é•¿åºåˆ—çš„åˆå§‹å¤„ç†
- **Decode**: å•tokenç”Ÿæˆ  
- **Hybrid**: Prefillå’ŒDecodeå¹¶å‘æ‰§è¡Œ

### GQA é…ç½®
- **Query Heads**: 64
- **KV Heads**: 8
- **GQA æ¯”ä¾‹**: 8:1 (æ¯ 8 ä¸ª query heads å…±äº« 1 ä¸ª KV head)
- **Head Dimension**: 128
- **KV Length**: 4096 tokens

---

## ğŸ“¦ æµ‹è¯•è„šæœ¬è¯¦è§£

### 1. prefill.py - Prefill æ€§èƒ½æµ‹è¯•

**ç”¨é€”**: æµ‹è¯• Prefill åœ¨ä¸åŒ SM æ•°é‡ä¸‹çš„æ€§èƒ½

**ç‰¹ç‚¹**:
- æ‰¹å¤„ç† 32 ä¸ªè¯·æ±‚
- Query é•¿åº¦ 4096 tokens
- **ä½¿ç”¨ Green Context çš„ primary partition æ¥é™åˆ¶ SM**
- è‡ªåŠ¨æµ‹è¯•ä» 8 åˆ°æœ€å¤§ SM çš„å®Œæ•´èŒƒå›´
- åŠ¨æ€è·å– GPU çš„å®é™… SM æ•°é‡

**è¿è¡Œæ–¹å¼**:
```bash
python prefill.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
======================================================================
æ€§èƒ½å¯¹æ¯”ç»“æœ
======================================================================
GPUæ€»SMæ•°: 132
å®Œæ•´SMåŸºçº¿æ—¶é—´: 8.234 ms

SMæ•°é‡     å æ¯”%        æ—¶é—´(ms)      æ€§èƒ½è¾¾åˆ°%    
----------------------------------------------------------------------
132        100.0%       8.234        100.0%      
8          6.1%         32.456       25.4%       
16         12.1%        18.234       45.2%       
32         24.2%        11.234       73.3%       
...
```

---

### 2. decode.py - Decode æ€§èƒ½æµ‹è¯•

**ç”¨é€”**: æµ‹è¯• Decode åœ¨ä¸åŒ SM æ•°é‡ä¸‹çš„æ€§èƒ½

**ç‰¹ç‚¹**:
- å¤§æ‰¹å¤„ç† 128 ä¸ªè¯·æ±‚ï¼ˆdecode é€šå¸¸ batch æ›´å¤§ï¼‰
- æ¯ä¸ªåºåˆ—ç”Ÿæˆ 1 ä¸ª token
- **ä½¿ç”¨ Green Context çš„ primary partition æ¥é™åˆ¶ SM**
- è‡ªåŠ¨æµ‹è¯•ä» 8 åˆ°æœ€å¤§ SM çš„å®Œæ•´èŒƒå›´

**è¿è¡Œæ–¹å¼**:
```bash
python decode.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
======================================================================
GQA Decode SM ç¼©æ”¾æµ‹è¯•
======================================================================
é…ç½®: Batch=128, KV_len=4096, Query_len=1 (decode)
GPUæ€»SMæ•°: 132, æµ‹è¯•èŒƒå›´: 8~132 (æ­¥é•¿8), è¿è¡Œ10æ¬¡
======================================================================

[1/17] æµ‹è¯•å®Œæ•´SM (æ— é™åˆ¶)...
  âœ“ å®Œæ•´SMæ—¶é—´: 2.345 ms

æ€§èƒ½å¯¹æ¯”ç»“æœ:
SMæ•°é‡     å æ¯”%        æ—¶é—´(ms)      æ€§èƒ½è¾¾åˆ°%    
----------------------------------------------------------------------
132        100.0%       2.345        100.0%      
8          6.1%         8.234        28.5%       
16         12.1%        4.567        51.4%       
...
```

---

### 3. hybrid.py - å¹¶å‘æµ‹è¯•ä¸æœ€ä¼˜SMåˆ†é… â­â­â­

**ç”¨é€”**: æµ‹è¯• Prefill å’Œ Decode å¹¶å‘æ‰§è¡Œï¼Œ**è‡ªåŠ¨æ‰¾å‡ºæœ€ä¼˜ SM åˆ†é…æ–¹æ¡ˆ**

**Green Context åŸç†**:
- **ä¸€æ¬¡æ€§åˆ’åˆ† SM**: ä½¿ç”¨ Green Context å°† GPU çš„ SM åˆ’åˆ†ä¸ºä¸¤ä¸ªpartition
- **Primary Partition**: åˆ†é…ç»™ Prefill (é«˜ä¼˜å…ˆçº§)
- **Remaining Partition**: åˆ†é…ç»™ Decode (æ­£å¸¸ä¼˜å…ˆçº§)
- **å¹¶å‘æ‰§è¡Œ**: ä¸¤ä¸ªä»»åŠ¡åœ¨å„è‡ªçš„ partition ä¸Šç‹¬ç«‹å¹¶å‘è¿è¡Œ

**ç‰¹ç‚¹**:
- **æ­¥éª¤ 1**: åœ¨å®Œæ•´ SM ä¸‹åˆ†åˆ«æµ‹è¯• Prefill å’Œ Decode çš„åŸºçº¿æ€§èƒ½
- **æ­¥éª¤ 2**: è‡ªåŠ¨åŒ–æµ‹è¯•ä¸åŒçš„ SM åˆ’åˆ†æ–¹æ¡ˆ
- æ¯æ¬¡æµ‹è¯•åˆ›å»ºä¸€ä¸ª Green Contextï¼Œåˆ’åˆ†ä¸º primary å’Œ remaining
- Prefill åœ¨ primary partition stream ä¸Šæ‰§è¡Œ
- Decode åœ¨ remaining partition stream ä¸Šæ‰§è¡Œ
- æµ‹é‡å¹¶å‘æ‰§è¡Œçš„æ€»æ—¶é—´
- **è‡ªåŠ¨æ‰¾å‡ºæœ€ä¼˜é…ç½®å¹¶è®¡ç®—åŠ é€Ÿæ¯”**
- Prefill ä½¿ç”¨å° batch (4)ï¼ŒDecode ä½¿ç”¨å¤§ batch (128)

**é…ç½®** (åœ¨ä»£ç ä¸­ä¿®æ”¹):
```python
PREFILL_BATCH_SIZE = 4      # Prefill batch size
PREFILL_QO_LEN = 4096       # Prefill query length  
DECODE_BATCH_SIZE = 128     # Decode batch size
DECODE_QO_LEN = 1           # Decode query length
KV_LEN = 4096
RUNS = 10
STEP = 8                    # SM æµ‹è¯•æ­¥é•¿
```

**è¿è¡Œæ–¹å¼**:
```bash
python hybrid.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
======================================================================
Hybrid Prefill + Decode SM åˆ†é…æµ‹è¯•
======================================================================
é…ç½®:
  GPUæ€»SMæ•°: 132
  Prefill: Batch=4, QO_len=4096
  Decode: Batch=128, QO_len=1
  KV_len=4096, è¿è¡Œ10æ¬¡
======================================================================

æ­¥éª¤ 1: æµ‹è¯•å®Œæ•´SMä¸‹çš„åŸºçº¿æ€§èƒ½ (é¡ºåºæ‰§è¡Œ)
======================================================================
è¯´æ˜: ä¸¤ä¸ªä»»åŠ¡éƒ½åœ¨å®Œæ•´SMä¸Šç‹¬ç«‹æµ‹è¯•ï¼Œæ€»æ—¶é—´ä¸ºä¸¤è€…ä¹‹å’Œ

æµ‹è¯• Prefill (å®Œæ•´SM)...
æµ‹è¯• Decode (å®Œæ•´SM)...

åŸºçº¿ç»“æœ (éƒ½åœ¨å®Œæ•´SMä¸Šç‹¬ç«‹æµ‹è¯•):
  Prefill æ—¶é—´: 850.3 ms (10 æ¬¡è¿è¡Œ)
  Decode æ—¶é—´: 78.2 ms (100 æ¬¡è¿è¡Œ)
  ----------------------------------------
  é¡ºåºæ‰§è¡Œæ€»æ—¶é—´ = 850.3 + 78.2 = 928.5 ms
======================================================================

æ­¥éª¤ 2: æµ‹è¯•ä¸åŒSMåˆ†é…æ–¹æ¡ˆ
å°†æµ‹è¯• 15 ç§SMåˆ†é…æ–¹æ¡ˆ
Primary (Prefill) SMèŒƒå›´: 8 åˆ° 124
======================================================================

[1/15] æµ‹è¯• Primary=8 SMs (Prefill), Remaining=124 SMs (Decode)...
  åˆ›å»ºGreen Context (Primary=8 SMs, Remaining=124 SMs)...
  âœ“ Green Contextåˆ›å»ºæˆåŠŸ
    å®é™…åˆ†é…: Primary=8 SMs, Remaining=124 SMs
  å¼€å§‹å¹¶å‘æ‰§è¡Œ...
  âœ“ æ€»æ—¶é—´=1450.5ms, Prefill=1420.3ms, Decode=138.2ms

[2/15] æµ‹è¯• Primary=16 SMs (Prefill), Remaining=116 SMs (Decode)...
  âœ“ æ€»æ—¶é—´=1220.1ms, Prefill=1210.5ms, Decode=115.3ms

[3/15] æµ‹è¯• Primary=108 SMs (Prefill), Remaining=24 SMs (Decode)...
  âœ“ æ€»æ—¶é—´=950.3ms, Prefill=930.2ms, Decode=92.5ms
...

====================================================================================================
æµ‹è¯•ç»“æœæ±‡æ€»
====================================================================================================
åŸºçº¿ (å®Œæ•´SMé¡ºåºæ‰§è¡Œ): 928.5 ms (Prefill=850.3ms + Decode=78.2ms)

Prefill_SM  Decode_SM   Prefill(ms)   Decode(ms)   æ€»æ—¶é—´(ms)    vsåŸºçº¿     æ ‡è®°       
----------------------------------------------------------------------------------------------------
8           124         1420.3        138.2        1450.5       0.64x                
16          116         1210.5        115.3        1220.1       0.76x                
108         24          930.2         92.5         950.3        0.98x      â˜… æœ€å¿«    
116         16          1010.5        108.7        1080.5       0.86x                
...
====================================================================================================

æ€§èƒ½æ€»ç»“:
  åŸºçº¿ (é¡ºåºæ‰§è¡Œ): 928.5 ms
  æœ€ä¼˜é…ç½®æ—¶é—´: 950.3 ms
  åŠ é€Ÿæ¯”: 0.98x
  æ€§èƒ½æå‡: -2.4%

  æœ€ä¼˜SMåˆ†é…:
    Prefill: 108 SMs (81.8%)
    Decode: 24 SMs (18.2%)
====================================================================================================
```

---

## ğŸ—ï¸ Green Context æ¶æ„è¯´æ˜

### å·¥ä½œåŸç†

Green Context æ˜¯ CUDA æä¾›çš„ SM èµ„æºåˆ’åˆ†æœºåˆ¶ï¼Œå…è®¸å°† GPU çš„ SM åˆ’åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„ partitionï¼š

```
GPU æ€»SM (ä¾‹å¦‚ 132 SMs)
â”œâ”€â”€ Primary Partition (ä¾‹å¦‚ 108 SMs)
â”‚   â”œâ”€â”€ Green Context 1
â”‚   â””â”€â”€ Stream 1 (é«˜ä¼˜å…ˆçº§ï¼Œè¿è¡Œ Prefill)
â””â”€â”€ Remaining Partition (ä¾‹å¦‚ 24 SMs)
    â”œâ”€â”€ Green Context 2
    â””â”€â”€ Stream 2 (æ­£å¸¸ä¼˜å…ˆçº§ï¼Œè¿è¡Œ Decode)
```

### å…³é”®ç‰¹ç‚¹

1. **ä¸€æ¬¡åˆ’åˆ†**: è°ƒç”¨ä¸€æ¬¡ `create_green_context_and_streams()`ï¼Œåˆ›å»ºä¸¤ä¸ª partition
2. **ç‹¬ç«‹èµ„æº**: æ¯ä¸ª partition æœ‰ç‹¬ç«‹çš„ SM èµ„æºå’Œ stream
3. **å¹¶å‘æ‰§è¡Œ**: ä¸¤ä¸ª stream å¯ä»¥çœŸæ­£å¹¶å‘ï¼Œä¸ä¼šäº’ç›¸æŠ¢å  SM
4. **ä¼˜å…ˆçº§éš”ç¦»**: Primary é«˜ä¼˜å…ˆçº§ï¼ŒRemaining æ­£å¸¸ä¼˜å…ˆçº§

### API ä½¿ç”¨

```python
import green_context_lib as green_context

# åˆ›å»ºGreen Contextï¼Œåˆ’åˆ†SMä¸ºprimaryå’Œremaining
primary_stream, remaining_stream, primary_sms, remaining_sms = \
    green_context.create_green_context_and_streams(
        intended_primary_sm_count=108,  # Primary partitionè¦108ä¸ªSM
        primary_stream_priority=-1,      # é«˜ä¼˜å…ˆçº§
        remaining_stream_priority=0       # æ­£å¸¸ä¼˜å…ˆçº§
    )

# Prefillåœ¨primary streamä¸Šæ‰§è¡Œ
with torch.cuda.stream(torch.cuda.Stream(stream_ptr=primary_stream)):
    prefill_output = prefill_kernel(...)

# Decodeåœ¨remaining streamä¸Šæ‰§è¡Œ
with torch.cuda.stream(torch.cuda.Stream(stream_ptr=remaining_stream)):
    decode_output = decode_kernel(...)

# ç­‰å¾…ä¸¤ä¸ªstreamå®Œæˆ
torch.cuda.synchronize()

# é”€æ¯Green Context
green_context.destroy_green_context()
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡è¯´æ˜

### å•ç‹¬æµ‹è¯• (prefill.py / decode.py)

- **SMæ•°é‡**: ä½¿ç”¨çš„SMæ•°é‡
- **å æ¯”%**: SMæ•°é‡å GPUæ€»SMçš„ç™¾åˆ†æ¯”
- **æ—¶é—´(ms)**: å¹³å‡æ‰§è¡Œæ—¶é—´ (è¶Šä½è¶Šå¥½)
- **æ€§èƒ½è¾¾åˆ°%**: è¾¾åˆ°å®Œæ•´SMæ€§èƒ½çš„ç™¾åˆ†æ¯” (è¶Šé«˜è¶Šå¥½)
  - è®¡ç®—: (å®Œæ•´SMæ—¶é—´ / å½“å‰æ—¶é—´) Ã— 100%
  - ä¾‹å¦‚ï¼šç”¨ 25% çš„ SM è¾¾åˆ° 73% çš„æ€§èƒ½

### Hybrid æµ‹è¯•

- **vsåŸºçº¿**: ç›¸å¯¹äºé¡ºåºæ‰§è¡Œçš„åŠ é€Ÿæ¯”
- **åŠ é€Ÿæ¯”**: åŸºçº¿æ—¶é—´ / å¹¶å‘æ—¶é—´
- **æ€§èƒ½æå‡**: (1 - å¹¶å‘æ—¶é—´/åŸºçº¿æ—¶é—´) Ã— 100%
- **â˜… æœ€å¿«**: æ ‡è®°æ€»æ—¶é—´æœ€çŸ­çš„é…ç½®

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

1. **å•é˜¶æ®µæ€§èƒ½åˆ†æ**: ä½¿ç”¨ `prefill.py` æˆ– `decode.py` äº†è§£å•ä¸ªé˜¶æ®µçš„ SM éœ€æ±‚
2. **å¹¶å‘ç³»ç»Ÿè®¾è®¡**: ä½¿ç”¨ `hybrid.py` æ‰¾å‡ºæœ€ä¼˜çš„ SM åˆ†é…ç­–ç•¥
3. **èµ„æºè§„åˆ’**: ç¡®å®šä¸åŒå·¥ä½œè´Ÿè½½æ‰€éœ€çš„æœ€å° SM æ•°é‡
4. **æ€§èƒ½ä¼˜åŒ–**: æ‰¾åˆ°æ€§ä»·æ¯”æœ€ä¼˜çš„ SM åˆ†é…æ–¹æ¡ˆ
5. **Prefill-Decode åˆ†ç¦»**: ä¸ºä¸¤ä¸ªé˜¶æ®µåˆ†é…ç‹¬ç«‹çš„ SM èµ„æº

---

## ğŸ“‹ ä¸‰ä¸ªè„šæœ¬å¯¹æ¯”

| ç‰¹æ€§ | prefill.py | decode.py | hybrid.py |
|------|-----------|-----------|-----------|
| **æµ‹è¯•å†…å®¹** | Prefill å•ç‹¬æµ‹è¯• | Decode å•ç‹¬æµ‹è¯• | Prefill+Decode å¹¶å‘ |
| **Batch Size** | 32 | 128 | 4 + 128 |
| **Query Length** | 4096 | 1 | 4096 + 1 |
| **æµ‹è¯•ç›®æ ‡** | å•é˜¶æ®µæ€§èƒ½ | å•é˜¶æ®µæ€§èƒ½ | æœ€ä¼˜SMåˆ†é… |
| **SMåˆ†é…** | æµ‹è¯•ä¸åŒSMæ•° | æµ‹è¯•ä¸åŒSMæ•° | è‡ªåŠ¨ä¼˜åŒ–åˆ†é… |
| **è¾“å‡ºç»“æœ** | æ€§èƒ½è¾¾åˆ°% | æ€§èƒ½è¾¾åˆ°% | æœ€ä¼˜é…ç½®+åŠ é€Ÿæ¯” |
| **åŸºçº¿æµ‹è¯•** | âœ“ | âœ“ | âœ“ (ä¸¤é˜¶æ®µ) |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# è¿›å…¥ç›®å½•
cd semi-pd

# 1. æµ‹è¯• Prefill æ€§èƒ½
python prefill.py

# 2. æµ‹è¯• Decode æ€§èƒ½
python decode.py

# 3. æ‰¾å‡ºæœ€ä¼˜ SM åˆ†é…ï¼ˆæ¨èï¼‰
python hybrid.py
```

---

## ğŸ“ ç¤ºä¾‹å·¥ä½œæµ

1. **äº†è§£åŸºçº¿æ€§èƒ½**:
   ```bash
   python prefill.py  # äº†è§£ prefill åœ¨ä¸åŒSMä¸‹çš„æ€§èƒ½
   python decode.py   # äº†è§£ decode åœ¨ä¸åŒSMä¸‹çš„æ€§èƒ½
   ```

2. **ä¼˜åŒ–å¹¶å‘é…ç½®**:
   ```bash
   python hybrid.py   # è‡ªåŠ¨æ‰¾å‡ºæœ€ä¼˜çš„ SM åˆ†é…æ–¹æ¡ˆ
   ```

3. **åº”ç”¨æœ€ä¼˜é…ç½®**:
   - æ ¹æ® hybrid.py çš„ç»“æœé…ç½®ç”Ÿäº§ç¯å¢ƒ
   - ä¸º prefill å’Œ decode åˆ†é…å¯¹åº”æ•°é‡çš„ SM
   - å®ç° prefill-decode å¹¶è¡Œæ‰§è¡Œ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒè¦æ±‚**:
   - ç¡®ä¿å·²æ­£ç¡®ç¼–è¯‘å’Œå®‰è£… `green_context_lib`
   - ç¡®ä¿ FlashInfer åº“å·²å®‰è£…ä¸”ç‰ˆæœ¬å…¼å®¹
   - PyTorch with CUDA support

2. **æµ‹è¯•ç¯å¢ƒ**:
   - å»ºè®®åœ¨æ— å…¶ä»– GPU è´Ÿè½½çš„ç¯å¢ƒä¸‹è¿è¡Œæµ‹è¯•ä»¥è·å¾—å‡†ç¡®ç»“æœ
   - hybrid æµ‹è¯•éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆæ¯ä¸ªé…ç½®çº¦2-3ç§’ï¼‰

3. **å‚æ•°è°ƒæ•´**:
   - æ‰€æœ‰é…ç½®å‚æ•°éƒ½åœ¨ä»£ç é¡¶éƒ¨å®šä¹‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
   - SM æµ‹è¯•æ­¥é•¿ (STEP) å¯ä»¥è°ƒæ•´ä»¥è·å¾—æ›´ç»†ç²’åº¦æˆ–æ›´å¿«çš„æµ‹è¯•

4. **GPUå…¼å®¹æ€§**:
   - è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹GPUçš„SMæ€»æ•°
   - é€‚ç”¨äºä¸åŒå‹å·çš„GPUï¼ˆH100: 132-188 SMs, A100: 108 SMsç­‰ï¼‰

---

## ğŸ“š å…¶ä»–æµ‹è¯•è„šæœ¬

### quick_sm_test.py - å…¼å®¹æ€§æµ‹è¯•

æ—©æœŸç‰ˆæœ¬çš„å•åºåˆ—æµ‹è¯•è„šæœ¬ï¼Œç°åœ¨æ¨èä½¿ç”¨ `prefill.py` å’Œ `decode.py`ã€‚

**è¿è¡Œæ–¹å¼**:
```bash
python quick_sm_test.py
```

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

- **2025-11-17 v6 (é‡å¤§æ›´æ–°)**:
  - **ä¿®æ­£ Green Context ä½¿ç”¨æ–¹å¼**: 
    - é‡å†™ `green_context_wrapper.cu`ï¼Œæ”¯æŒä¸€æ¬¡æ€§åˆ’åˆ† primary å’Œ remaining partition
    - è¿”å›ä¸¤ä¸ª stream handles å’Œå®é™…çš„ SM åˆ†é…æ•°é‡
    - API: `create_green_context_and_streams()` è¿”å› (primary_stream, remaining_stream, primary_sms, remaining_sms)
  - **é‡å†™ hybrid.py**:
    - ä½¿ç”¨æ–°çš„ Green Context API
    - ç®€åŒ–ä»£ç æ¶æ„ï¼Œå»æ‰å¤šè¿›ç¨‹
    - ä¸€æ¬¡åˆ’åˆ† SMï¼šPrefill ç”¨ primary partitionï¼ŒDecode ç”¨ remaining partition
    - æ·»åŠ å®Œæ•´ SM ä¸‹çš„åŸºçº¿æµ‹è¯•
    - è¾“å‡ºæ ¼å¼æ›´ç®€æ´ï¼š6åˆ—å…³é”®æ•°æ®
  - **æ›´æ–° prefill.py å’Œ decode.py**:
    - ä½¿ç”¨ Green Context çš„ primary partition stream æ¥é™åˆ¶ SM
    - ä¸å†ä½¿ç”¨ `switch_to_green_context()` è¿™ç§é”™è¯¯çš„æ–¹å¼
    - æ­£ç¡®çš„åšæ³•ï¼šåˆ›å»º Green Context ååœ¨ primary stream ä¸Šæ‰§è¡Œ
  - **æ›´æ–°æ–‡æ¡£**:
    - æ·»åŠ  Green Context æ¶æ„è¯´æ˜
    - æ·»åŠ  API ä½¿ç”¨ç¤ºä¾‹
    - æ›´æ–°è¾“å‡ºç¤ºä¾‹ä»¥åæ˜ æ­£ç¡®çš„æœ¯è¯­ï¼ˆPrimary/Remainingï¼‰

- **2025-11-17 v5**:
  - hybrid.py æ·»åŠ å®Œæ•´SMä¸‹çš„åŸºçº¿æµ‹è¯•
  - æ˜¾ç¤ºåŠ é€Ÿæ¯”å’Œæ€§èƒ½æå‡ç™¾åˆ†æ¯”
  - æ›´æ–° README.md æ–‡æ¡£

- **2025-11-17 v4**: 
  - å»æ‰"æ—¶é—´å æ¯”%"åˆ—ï¼Œç®€åŒ–è¾“å‡º
  - åŠ¨æ€è·å–GPUçš„å®é™…SMæ•°é‡
  - decode.py batch size æ”¹ä¸º 128
  - hybrid.py é‡æ„ä¸ºè‡ªåŠ¨åŒ–æµ‹è¯•

---

## ğŸ“ ä¾èµ–é¡¹

```bash
pip install torch flashinfer pybind11
```

- PyTorch (with CUDA support)
- FlashInfer
- green_context_lib (éœ€è¦ç¼–è¯‘)
- pybind11 (ç¼–è¯‘æ—¶éœ€è¦)
